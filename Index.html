<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n - Tesoros Americanos Costa Rica</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #004d99; --secondary-color: #007bff; --text-color: #2c3e50; --light-text-color: #7f8c8d;
            --background-color: #ecf0f1; --card-background: #ffffff; --border-color: #dde1e5; --success-color: #27ae60;
            --danger-color: #e74c3c; --cancel-color: #95a5a6; --whatsapp-color: #25D366; --hover-shadow: 0 4px 15px rgba(0,0,0,0.1);
            --pdf-color: #c0392b; --tools-color: #f39c12; --traslado-color: #8e44ad;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 2.5vw; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: auto; background: var(--card-background); padding: 3vw; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid var(--border-color); margin-bottom: 30px; }
        .header-logo { text-align: center; margin-bottom: 30px; }
        .header-logo img { max-width: 180px; }
        .header-logo h1 { margin: 0; padding-top: 15px; border-top: 2px solid var(--border-color); font-size: clamp(1.8em, 4vw, 2.5em); font-weight: 700; color: var(--primary-color); }
        .header-logo h2.subtitle { margin: 5px 0 0; font-size: clamp(1em, 2.5vw, 1.5em); font-weight: 500; color: var(--secondary-color); }
        h2 { text-align: center; color: var(--primary-color); margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); border-radius: 10px; overflow: hidden; }
        th, td { border: 1px solid var(--border-color); padding: 0.8em 1em; text-align: left; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 0.7em 0.8em; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        .btn { padding: 0.8em 1.5em; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s ease; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--hover-shadow); }
        .btn-add { background-color: var(--success-color); color: white; }
        .btn-send { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-whatsapp { background-color: var(--whatsapp-color); color: white; }
        .btn-cancel { background-color: var(--cancel-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-pdf { background-color: var(--pdf-color); color: white; }
        .btn-tools { background-color: var(--tools-color); color: white; }
        .btn-traslado { background-color: var(--traslado-color); color: white; }
        .info-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5em; margin-bottom: 2em; }
        .form-group label { display: block; margin-bottom: 0.5em; font-weight: 500; color: var(--light-text-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; padding: 1em; }
        .modal-content { background-color: var(--card-background); padding: 2em; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 95%; max-width: 700px; position: relative; }
        .menu-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; margin-top: 2em; }
        .hidden { display: none; }
        .controls { margin-top: 40px; display: flex; justify-content: flex-end; gap: 1em; align-items: center; padding-top: 25px; border-top: 1px solid var(--border-color); flex-wrap: wrap; }
        .controls .left-buttons { margin-right: auto; display: flex; gap: 1em; }
        .tool-card { background-color: #f8f9fa; padding: 1.5em; border-radius: 8px; border: 1px solid var(--border-color); }
        .tool-card h3 { margin-top: 0; color: var(--secondary-color); }
        .tool-card p { font-family: 'Roboto Mono', monospace; font-size: 1.1em; }
        .converter-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1em; align-items: flex-end; }
        .summary-box { text-align: right; margin-top: 20px; font-size: 1.1em; font-weight: 500; }
        #loadingIndicator { text-align: center; font-size: 1.2em; color: var(--primary-color); padding: 2em; }
        @media screen and (max-width: 768px) {
            body { padding: 15px; } .container { padding: 20px; } .menu-options, .info-section { grid-template-columns: 1fr; }
            .converter-grid { grid-template-columns: 1fr; }
            .responsive-table thead { display: none; }
            .responsive-table, .responsive-table tbody, .responsive-table tr { display: block; width: 100%; }
            .responsive-table tr { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); overflow: hidden; }
            .responsive-table > tbody > tr > td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 12px 15px; border: none; word-break: break-word; min-height: 44px; border-bottom: 1px dotted var(--border-color); }
            .responsive-table > tbody > tr > td:last-child { border-bottom: none; }
            .responsive-table > tbody > tr > td::before { content: attr(data-label); font-weight: 700; color: var(--primary-color); text-align: left; padding-right: 15px; flex-shrink: 0; }
            .controls { flex-direction: column; gap: 10px; } .controls .btn { width: 100%; }
            .controls .left-buttons { flex-direction: column; width: 100%; margin: 0 0 10px 0; }
        }
    </style>
</head>
<body>

    <div class="container" id="mainContainer">
        <div id="loadingIndicator">Cargando bases de datos...</div>
        <div id="mainMenu" class="hidden"></div>
    </div>
    
    <div class="container hidden" id="formContainer"></div>
    <div class="container hidden" id="historyContainer"></div>
    <div class="container hidden" id="adminContainer"></div>
    <div class="container hidden" id="comprasContainer"></div>
    <div class="container hidden" id="historialComprasContainer"></div>
    <div class="container hidden" id="inventarioContainer"></div>
    <div class="container hidden" id="adminCategoriasContainer"></div>
    <div class="container hidden" id="herramientasContainer"></div>
    <div class="container hidden" id="conversorFechasContainer"></div>
    <div class="container hidden" id="conversorUnidadesContainer"></div>
    <div class="container hidden" id="conversorMonedasContainer"></div>
    <div class="container hidden" id="trasladoContainer"></div>
    <div class="container hidden" id="historialTrasladosContainer"></div>

    <div id="summaryModal" class="modal"></div>
    <div id="securityModal" class="modal"></div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxQprU0Z8Uw6WkGRmYAoyahfdfxPliD7BagdNykS2U4Vs3p_7kmC1zoRQj2YeUiwm3LiA/exec";
        let catalogoArticulos = [], historial = [], historialCompras = [], inventario = [];
        let costosPromedio = {};
        let currentRequestData = {};
        let exchangeRates = {};
        let historialTraslados = [];
        let categoriasTrasladoDB = [];
        
        const ubicacionesTraslado = ['Oficina', 'Centro Distribuci√≥n', 'Barrio M√©xico', 'San Francisco', 'Alto Valor', 'Directtools SF', 'Directtools BM', 'Bodega Externa'];
        
        let views = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            views = {
                mainContainer: document.getElementById('mainContainer'),
                mainMenu: document.getElementById('mainMenu'),
                loadingIndicator: document.getElementById('loadingIndicator'),
                formContainer: document.getElementById('formContainer'),
                historyContainer: document.getElementById('historyContainer'),
                adminContainer: document.getElementById('adminContainer'),
                comprasContainer: document.getElementById('comprasContainer'),
                historialComprasContainer: document.getElementById('historialComprasContainer'),
                inventarioContainer: document.getElementById('inventarioContainer'), 
                adminCategoriasContainer: document.getElementById('adminCategoriasContainer'),
                herramientasContainer: document.getElementById('herramientasContainer'),
                conversorFechasContainer: document.getElementById('conversorFechasContainer'),
                conversorUnidadesContainer: document.getElementById('conversorUnidadesContainer'),
                conversorMonedasContainer: document.getElementById('conversorMonedasContainer'),
                trasladoContainer: document.getElementById('trasladoContainer'),
                historialTrasladosContainer: document.getElementById('historialTrasladosContainer'),
                summaryModal: document.getElementById('summaryModal'),
                securityModal: document.getElementById('securityModal')
            };
            initializeApp();
        });
        
        async function initializeApp() {
            try {
                // **CAMBIO**: Carga secuencial y con mensajes de estado
                views.loadingIndicator.textContent = 'Cargando Art√≠culos...';
                await catalogoArticulos();
                
                views.loadingIndicator.textContent = 'Cargando Categor√≠as de Traslado...';
                await cargarCategoriasTraslado();
                
                views.loadingIndicator.textContent = 'Cargando Compras...';
                await cargarCompras();

                views.loadingIndicator.classList.add('hidden');
                views.mainMenu.innerHTML = `<div class="header-logo"><img src="data:image/svg+xml;base64," alt="Logo"><h1>Tesoros Americanos Costa Rica</h1><h2 class="subtitle">Sistema de Gesti√≥n</h2></div>
                <div class="menu-options">
                    <button class="btn" onclick="showForm()">üì¶ Nuevo Pedido</button>
                    <button class="btn" onclick="showHistory()">üìú Ver Pedidos</button>
                    <button class="btn btn-traslado" onclick="showFormTraslado()">üöö Nuevo Traslado</button>
                    <button class="btn btn-traslado" onclick="showHistorialTraslados()">üìã Ver Traslados</button>
                    <button class="btn" onclick="showCompras()">üõí Registrar Compra</button>
                    <button class="btn" onclick="showHistorialCompras()">üìä Consultar Compras</button>
                    <button class="btn" onclick="showInventario()">üìà Ver Inventario</button>
                    <button class="btn" onclick="showAdminArticulos()">‚úèÔ∏è Administrar Art√≠culos</button>
                    <button class="btn btn-traslado" onclick="showAdminCategorias()">‚öôÔ∏è Adm. Categor√≠as</button>
                    <button class="btn btn-tools" onclick="showHerramientas()">üõ†Ô∏è Herramientas</button>
                </div>`;
                views.mainMenu.classList.remove('hidden');

            } catch (error) {
                views.loadingIndicator.textContent = `Error al cargar la aplicaci√≥n: ${error.message}`;
                views.loadingIndicator.style.color = 'var(--danger-color)';
            }
        }

        function showView(viewId) {
            Object.values(views).forEach(v => {
                if (v && v.classList && !v.classList.contains('modal')) {
                    v.classList.add('hidden');
                }
            });
            views.mainContainer.classList.add('hidden');
            views[viewId].classList.remove('hidden');
        }

        function goBack() {
            Object.values(views).forEach(v => {
                 if (v && v.classList && !v.classList.contains('modal')) {
                    v.classList.add('hidden');
                }
            });
            views.mainContainer.classList.remove('hidden');
            views.mainMenu.classList.remove('hidden');
        }
        
        // --- INICIO M√ìDULO DE ADMINISTRACI√ìN DE CATEGOR√çAS ---

        function showAdminCategorias() {
            views.adminCategoriasContainer.innerHTML = `
                <h2>‚öôÔ∏è Administrar Categor√≠as de Traslado</h2>
                <table id="admin-categorias-table" class="responsive-table">
                    <thead><tr><th>Tipo</th><th>C√≥digo</th><th>Categor√≠a</th><th>Acci√≥n</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="controls">
                    <button class="btn btn-add" onclick="agregarFilaAdminCategorias()">‚ûï Agregar Categor√≠a</button>
                    <button class="btn btn-cancel" onclick="goBack()">‚¨ÖÔ∏è Volver</button>
                    <button class="btn btn-send" onclick="guardarCategoriasTraslados()">üíæ Guardar Cambios</button>
                </div>`;
            showView('adminCategoriasContainer');
            
            const tableBody = views.adminCategoriasContainer.querySelector('tbody');
            tableBody.innerHTML = '';
            
            if(categoriasTrasladoDB.length === 0){
                 tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No hay categor√≠as definidas. Agregue una nueva.</td></tr>`;
                 return;
            }

            categoriasTrasladoDB.forEach(cat => {
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `
                    <td data-label="Tipo"><input type="text" value="${cat.tipo}"></td>
                    <td data-label="C√≥digo"><input type="text" value="${cat.codigo}"></td>
                    <td data-label="Categor√≠a"><input type="text" value="${cat.categoria}"></td>
                    <td data-label="Acci√≥n"><button class="btn btn-danger" onclick="this.closest('tr').remove()">Eliminar</button></td>
                `;
            });
        }
        
        function agregarFilaAdminCategorias() {
            const tableBody = views.adminCategoriasContainer.querySelector('tbody');
            if(tableBody.rows.length === 1 && tableBody.rows[0].cells.length === 1){
                tableBody.innerHTML = '';
            }
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td data-label="Tipo"><input type="text" placeholder="Ej: EQUIPO"></td>
                <td data-label="C√≥digo"><input type="text" placeholder="Ej: EQP-001"></td>
                <td data-label="Categor√≠a"><input type="text" placeholder="Ej: Laptop Dell"></td>
                <td data-label="Acci√≥n"><button class="btn btn-danger" onclick="this.closest('tr').remove()">Eliminar</button></td>
            `;
        }
        
        async function guardarCategoriasTraslados() {
            checkSecurityKey(async () => {
                const nuevasCategorias = [];
                views.adminCategoriasContainer.querySelectorAll('tbody tr').forEach(row => {
                    const tipo = row.cells[0].querySelector('input').value.trim();
                    const codigo = row.cells[1].querySelector('input').value.trim();
                    const categoria = row.cells[2].querySelector('input').value.trim();
                    if (tipo && codigo && categoria) {
                        nuevasCategorias.push({ tipo, codigo, categoria });
                    }
                });
                
                if (!confirm(`¬øDesea sobrescribir la lista de categor√≠as con ${nuevasCategorias.length} registros?`)) return;
                
                try {
                    await fetch(WEB_APP_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'updateCategoriasTraslados', payload: nuevasCategorias }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    alert('¬°Lista de categor√≠as actualizada!');
                    categoriasTrasladoDB = nuevasCategorias;
                    goBack();
                } catch (error) {
                    alert('Error al guardar las categor√≠as.');
                    console.error(error);
                }
            });
        }
        
        async function cargarCategoriasTraslado() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getCategoriasTraslados`);
                if(!response.ok) throw new Error(`Error de red: ${response.statusText}`);
                const data = await response.json();
                if(data.error) throw new Error(data.message);
                categoriasTrasladoDB = data;
            } catch (e) {
                console.error("Error al cargar categor√≠as de traslado:", e);
                throw new Error("No se pudo cargar la base de datos de Categor√≠as de Traslado.");
            }
        }
        
        // --- INICIO DE FUNCIONES PARA TRASLADOS ---

        function showFormTraslado() {
            const ubicacionesOptions = ubicacionesTraslado.map(u => `<option value="${u}">${u}</option>`).join('');
            
            views.trasladoContainer.innerHTML = `
                <h2>üöö Nuevo Traslado Interno</h2>
                <div class="info-section">
                    <div class="form-group"><label>Fecha:</label><input type="date" id="traslado-fecha" readonly></div>
                    <div class="form-group"><label>Origen:</label><select id="traslado-origen" onchange="actualizarOpcionesDestino(this.value)">${ubicacionesOptions}</select></div>
                    <div class="form-group"><label>Destino:</label><select id="traslado-destino">${ubicacionesOptions}</select></div>
                    <div class="form-group"><label>Realizado por:</label><input type="text" id="traslado-realizadopor"></div>
                    <div class="form-group"><label>Solicitado por:</label><input type="text" id="traslado-solicitadopor"></div>
                </div>
                <h3>Detalle de Art√≠culos</h3>
                <table id="traslado-table" class="responsive-table">
                    <thead><tr><th>N¬∞ Contenedor</th><th>Tipo</th><th>C√≥digo</th><th>Categor√≠a</th><th>Cantidad</th><th>Acci√≥n</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="summary-box">
                    <p>Total de Art√≠culos (l√≠neas): <span id="traslado-total-items">0</span></p>
                    <p>Total de Unidades: <span id="traslado-total-unidades">0</span></p>
                </div>
                <div class="controls">
                    <button class="btn btn-add" onclick="agregarFilaTraslado()">‚ûï Agregar Art√≠culo</button>
                    <button class="btn btn-cancel" onclick="goBack()">‚¨ÖÔ∏è Volver</button>
                    <button class="btn btn-send" onclick="previsualizarTraslado()">üì≤ Previsualizar y Guardar</button>
                </div>
            `;
            showView('trasladoContainer');
            document.getElementById('traslado-fecha').valueAsDate = new Date();
            const origenInicial = document.getElementById('traslado-origen').value;
            actualizarOpcionesDestino(origenInicial);
            agregarFilaTraslado();
        }

        function agregarFilaTraslado() {
            const tableBody = document.getElementById('traslado-table').querySelector('tbody');
            const newRow = tableBody.insertRow();
            const tiposUnicos = [...new Set(categoriasTrasladoDB.map(c => c.tipo))];
            const tiposOptions = tiposUnicos.map(t => `<option value="${t}">${t}</option>`).join('');
            
            newRow.innerHTML = `
                <td data-label="N¬∞ Contenedor"><input type="text" class="traslado-contenedor" placeholder="Ej: C1-A"></td>
                <td data-label="Tipo"><select class="traslado-tipo" onchange="actualizarCategoriasPorTipo(this)"><option value="">Seleccione</option>${tiposOptions}</select></td>
                <td data-label="C√≥digo"><input type="text" class="traslado-codigo" readonly></td>
                <td data-label="Categor√≠a"><select class="traslado-categoria" onchange="actualizarCodigoPorCategoria(this)" disabled><option value="">Seleccione tipo</option></select></td>
                <td data-label="Cantidad"><input type="number" class="traslado-cantidad" value="1" min="1" oninput="actualizarTotalesTraslado()"></td>
                <td data-label="Acci√≥n"><button class="btn btn-danger" onclick="this.closest('tr').remove(); actualizarTotalesTraslado();">Eliminar</button></td>
            `;
            actualizarTotalesTraslado();
        }
        
        function actualizarCategoriasPorTipo(tipoSelect) { /* ...c√≥digo sin cambios... */ }
        function actualizarCodigoPorCategoria(categoriaSelect) { /* ...c√≥digo sin cambios... */ }
        function actualizarOpcionesDestino(origenSeleccionado) { /* ...c√≥digo sin cambios... */ }
        function actualizarTotalesTraslado() { /* ...c√≥digo sin cambios... */ }
        function previsualizarTraslado() { /* ...c√≥digo sin cambios... */ }
        async function guardarTrasladoEnAPI(traslado) { /* ...c√≥digo sin cambios... */ }
        async function confirmarYGuardarTraslado(event) { /* ...c√≥digo sin cambios... */ }
        async function guardarYEnviarTrasladoPorWhatsApp(event) { /* ...c√≥digo sin cambios... */ }
        
        async function showHistorialTraslados() {
            views.historialTrasladosContainer.innerHTML = `
                <h2>üìã Historial de Traslados</h2>
                <table id="historial-traslados-table" class="responsive-table">
                    <thead><tr><th style="width:5%"><input type="checkbox" onchange="toggleSeleccionarTodosTraslados(this)"></th><th>ID</th><th>Fecha</th><th>Origen</th><th>Destino</th><th>Realizado por</th><th>Solicitado por</th><th>Detalles</th></tr></thead>
                    <tbody><tr><td colspan="8" style="text-align:center;">Cargando...</td></tr></tbody>
                </table>
                <div class="controls">
                    <div class="left-buttons"><button class="btn btn-danger" onclick="borrarTrasladosSeleccionados()">üóëÔ∏è Borrar Seleccionados</button></div>
                    <button class="btn btn-success" onclick="exportarHistorialTrasladosExcel()">üìä Exportar a Excel</button>
                    <button class="btn btn-pdf" onclick="exportarHistorialTrasladosPDF()">üìÑ Exportar a PDF</button>
                    <button class="btn btn-cancel" onclick="goBack()">‚¨ÖÔ∏è Volver</button>
                </div>`;
            showView('historialTrasladosContainer');

            try {
                const response = await fetch(`${WEB_APP_URL}?action=getTraslados`);
                if(!response.ok) throw new Error('Respuesta de red no fue exitosa.');
                const data = await response.json();
                if(data.error) throw new Error(data.message);
                historialTraslados = data;
                renderHistorialTraslados();
            } catch (e) {
                console.error(e);
                views.historialTrasladosContainer.querySelector('tbody').innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Error al cargar el historial.</td></tr>`;
            }
        }
        
        function toggleSeleccionarTodosTraslados(source) { /* ...c√≥digo sin cambios... */ }
        function renderHistorialTraslados() { /* ...c√≥digo sin cambios... */ }
        function borrarTrasladosSeleccionados() { /* ...c√≥digo sin cambios... */ }
        function exportarHistorialTrasladosExcel() { /* ...c√≥digo sin cambios... */ }
        function exportarHistorialTrasladosPDF() { /* ...c√≥digo sin cambios... */ }
        // --- FIN DE FUNCIONES PARA TRASLADOS ---

        // --- INICIO DE FUNCIONES PARA HERRAMIENTAS ---
        function showHerramientas() { /* ...c√≥digo sin cambios... */ }
        async function showConversorMonedas() { /* ...c√≥digo sin cambios... */ }
        function convertirMoneda() { /* ...c√≥digo sin cambios... */ }
        function showConversorFechas() { /* ...c√≥digo sin cambios... */ }
        function showConversorUnidades() { /* ...c√≥digo sin cambios... */ }
        const conversionFactors = { /* ...c√≥digo sin cambios... */ };
        function findUnitData(unitKey) { /* ...c√≥digo sin cambios... */ }
        function convertirUnidad() { /* ...c√≥digo sin cambios... */ }
        function calcularFechaJulianaYYDDD() { /* ...c√≥digo sin cambios... */ }
        function convertirAFechaGregoriana() { /* ...c√≥digo sin cambios... */ }
        // --- FIN DE FUNCIONES PARA HERRAMIENTAS ---
        
        // --- INICIO FUNCIONES DE PEDIDOS, COMPRAS, ETC. ---
        
        async function cargarCatalogoArticulos() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getArticulos`);
                if(!response.ok) throw new Error('Error de red');
                const data = await response.json();
                if(data.error) throw new Error(data.message);
                catalogoArticulos = data;
            } catch (e) { 
                console.error("Error al cargar cat√°logo de art√≠culos:", e);
                throw new Error("No se pudo cargar la base de datos de Art√≠culos.");
            }
        }
        
        async function cargarCompras() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getCompras`);
                if(!response.ok) throw new Error('Error de red');
                const data = await response.json();
                if(data.error) throw new Error(data.message);
                historialCompras = data;
            } catch (e) { 
                console.error("Error al cargar historial de compras:", e);
                throw new Error("No se pudo cargar la base de datos de Compras.");
            }
        }

        function calcularCostosPromedio() {
            const calculos = {};
            (historialCompras || []).forEach(compra => {
                if (!calculos[compra.articulo]) {
                    calculos[compra.articulo] = { totalCosto: 0, totalCantidad: 0 };
                }
                calculos[compra.articulo].totalCosto += parseFloat(compra.costoTotal);
                calculos[compra.articulo].totalCantidad += parseFloat(compra.cantidad);
            });
            costosPromedio = {};
            for (const articulo in calculos) {
                if (calculos[articulo].totalCantidad > 0) {
                    costosPromedio[articulo] = calculos[articulo].totalCosto / calculos[articulo].totalCantidad;
                }
            }
        }

        function checkSecurityKey(callback) { /* ...c√≥digo sin cambios... */ }
        function showForm() { /* ...c√≥digo sin cambios... */ }
        function agregarFila() { /* ...c√≥digo sin cambios... */ }
        function actualizarArticulos(selectUnidad) { /* ...c√≥digo sin cambios... */ }
        function cambiarCantidad(btn,delta){ /* ...c√≥digo sin cambios... */ }
        function actualizarTotalesPedido() { /* ...c√≥digo sin cambios... */ }
        function previsualizarPedido() { /* ...c√≥digo sin cambios... */ }
        async function guardarPedidoEnAPI(pedido) { /* ...c√≥digo sin cambios... */ }
        async function confirmarYGuardar(event) { /* ...c√≥digo sin cambios... */ }
        async function guardarYEnviarPorWhatsApp(event) { /* ...c√≥digo sin cambios... */ }
        async function showHistory() { /* ...c√≥digo sin cambios... */ }
        function renderHistorial() { /* ...c√≥digo sin cambios... */ }
        function toggleSeleccionarTodos(source) { /* ...c√≥digo sin cambios... */ }
        function reenviarPedidosSeleccionados() { /* ...c√≥digo sin cambios... */ }
        function borrarPedidosSeleccionados() { /* ...c√≥digo sin cambios... */ }
        function exportarHistorialPedidosExcel() { /* ...c√≥digo sin cambios... */ }
        function exportarHistorialPedidosPDF() { /* ...c√≥digo sin cambios... */ }
        function showAdminArticulos() { /* ...c√≥digo sin cambios... */ }
        function agregarFilaAdmin() { /* ...c√≥digo sin cambios... */ }
        function eliminarFilaAdmin(boton) { /* ...c√≥digo sin cambios... */ }
        async function guardarArticulos() { /* ...c√≥digo sin cambios... */ }
        async function showCompras() { /* ...c√≥digo sin cambios... */ }
        function agregarFilaCompra() { /* ...c√≥digo sin cambios... */ }
        function cambiarCantidadCompra(btn, delta) { /* ...c√≥digo sin cambios... */ }
        function actualizarTotalesCompra() { /* ...c√≥digo sin cambios... */ }
        async function registrarCompra() { /* ...c√≥digo sin cambios... */ }
        async function showHistorialCompras() { /* ...c√≥digo sin cambios... */ }
        function renderHistorialCompras() { /* ...c√≥digo sin cambios... */ }
        function exportarHistorialComprasExcel() { /* ...c√≥digo sin cambios... */ }
        async function showInventario() { /* ...c√≥digo sin cambios... */ }
        function renderInventario() { /* ...c√≥digo sin cambios... */ }
        function exportarInventarioExcel() { /* ...c√≥digo sin cambios... */ }
    </script>
</body>
</html>
