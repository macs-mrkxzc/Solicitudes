<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión - Tesoros Americanos Costa Rica</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #004d99; --secondary-color: #007bff; --text-color: #2c3e50; --light-text-color: #7f8c8d;
            --background-color: #ecf0f1; --card-background: #ffffff; --border-color: #dde1e5; --success-color: #27ae60;
            --danger-color: #e74c3c; --cancel-color: #95a5a6; --whatsapp-color: #25D366; --hover-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 2.5vw; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: auto; background: var(--card-background); padding: 3vw; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid var(--border-color); margin-bottom: 30px; }
        .header-logo { text-align: center; margin-bottom: 30px; }
        .header-logo img { max-width: 180px; }
        .header-logo h1 { margin: 0; padding-top: 15px; border-top: 2px solid var(--border-color); font-size: clamp(1.8em, 4vw, 2.5em); font-weight: 700; color: var(--primary-color); }
        .header-logo h2.subtitle { margin: 5px 0 0; font-size: clamp(1em, 2.5vw, 1.5em); font-weight: 500; color: var(--secondary-color); }
        h2 { text-align: center; color: var(--primary-color); margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); border-radius: 10px; overflow: hidden; }
        th, td { border: 1px solid var(--border-color); padding: 0.8em 1em; text-align: left; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 0.7em 0.8em; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        .btn { padding: 0.8em 1.5em; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s ease; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--hover-shadow); }
        .btn-add { background-color: var(--success-color); color: white; }
        .btn-send { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-whatsapp { background-color: var(--whatsapp-color); color: white; }
        .btn-cancel { background-color: var(--cancel-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .info-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5em; margin-bottom: 2em; }
        .form-group label { display: block; margin-bottom: 0.5em; font-weight: 500; color: var(--light-text-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; padding: 1em; }
        .modal-content { background-color: var(--card-background); padding: 2em; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 95%; max-width: 700px; position: relative; }
        .menu-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; margin-top: 2em; }
        .hidden { display: none; }
        .controls { margin-top: 40px; display: flex; justify-content: flex-end; gap: 1em; align-items: center; padding-top: 25px; border-top: 1px solid var(--border-color); flex-wrap: wrap; }
        @media screen and (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 20px; }
            .menu-options, .info-section { grid-template-columns: 1fr; }
            .responsive-table thead { display: none; }
            .responsive-table, .responsive-table tbody, .responsive-table tr { display: block; width: 100%; }
            .responsive-table tr { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); overflow: hidden; }
            .responsive-table > tbody > tr > td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 12px 15px; border: none; word-break: break-word; min-height: 44px; border-bottom: 1px dotted var(--border-color); }
            .responsive-table > tbody > tr > td:last-child { border-bottom: none; }
            .responsive-table > tbody > tr > td::before { content: attr(data-label); font-weight: 700; color: var(--primary-color); text-align: left; padding-right: 15px; flex-shrink: 0; }
            #pedido-table > tbody > tr > td:nth-of-type(1)::before { content: "Unidad"; }
            #pedido-table > tbody > tr > td:nth-of-type(2)::before { content: "Artículo"; }
            #pedido-table > tbody > tr > td:nth-of-type(3)::before { content: "Cantidad"; }
            #pedido-table > tbody > tr > td:nth-of-type(4)::before { content: "Costo Total"; }
            #pedido-table > tbody > tr > td:nth-of-type(5)::before { content: ""; }
            /* ... (resto de estilos responsivos) ... */
            .controls, .modal-actions { flex-direction: column; gap: 15px; }
            .controls .btn, .modal-actions .btn { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container" id="mainMenu">
        </div>

    <div class="container hidden" id="formContainer"></div>
    <div class="container hidden" id="historyContainer"></div>
    <div class="container hidden" id="adminContainer"></div>
    <div class="container hidden" id="comprasContainer"></div>
    <div class="container hidden" id="historialComprasContainer"></div>
    <div class="container hidden" id="inventarioContainer"></div>
    <div id="summaryModal" class="modal"></div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxZwboxYJuMqF6pwc8icP2F3j4Xywrjhyjgbor5fFrUmBXW3cTx18DlFm8CGfFyIOcRBQ/exec";
        let catalogoArticulos = [], historial = [], historialCompras = [], inventario = [];
        let costosPromedio = {};
        let currentRequestData = {};

        const views = {
            mainMenu: document.getElementById('mainMenu'),
            formContainer: document.getElementById('formContainer'),
            historyContainer: document.getElementById('historyContainer'),
            adminContainer: document.getElementById('adminContainer'),
            comprasContainer: document.getElementById('comprasContainer'),
            historialComprasContainer: document.getElementById('historialComprasContainer'),
            inventarioContainer: document.getElementById('inventarioContainer'),
            summaryModal: document.getElementById('summaryModal')
        };

        function showView(viewId) { Object.values(views).forEach(v => v.classList.add('hidden')); views[viewId].classList.remove('hidden'); }
        function goBack() { showView('mainMenu'); }

        async function cargarDatosEsenciales() {
            // Carga todos los datos necesarios en paralelo para optimizar
            await Promise.all([
                (async () => {
                    if (catalogoArticulos.length === 0) await cargarCatalogoArticulos();
                })(),
                (async () => {
                    if (historialCompras.length === 0) {
                        try {
                            const response = await fetch(`${WEB_APP_URL}?action=getCompras`);
                            historialCompras = await response.json();
                        } catch (e) { console.error("Error cargando compras"); }
                    }
                })()
            ]);
            calcularCostosPromedio();
        }

        async function cargarCatalogoArticulos() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getArticulos`);
                catalogoArticulos = await response.json();
            } catch (e) { alert("No se pudo cargar la lista de artículos."); }
        }

        function calcularCostosPromedio() {
            const calculos = {};
            historialCompras.forEach(compra => {
                if (!calculos[compra.articulo]) {
                    calculos[compra.articulo] = { totalCosto: 0, totalCantidad: 0 };
                }
                calculos[compra.articulo].totalCosto += parseFloat(compra.costoTotal);
                calculos[compra.articulo].totalCantidad += parseFloat(compra.cantidad);
            });
            
            costosPromedio = {};
            for (const articulo in calculos) {
                if (calculos[articulo].totalCantidad > 0) {
                    costosPromedio[articulo] = calculos[articulo].totalCosto / calculos[articulo].totalCantidad;
                }
            }
        }
        
        // --- Lógica de PEDIDOS ---
        async function showForm() {
            views.formContainer.innerHTML = `<h2>Nuevo Pedido</h2>
                <div class="info-section">
                    <div class="form-group"><label for="solicitante">Solicitado por:</label><input type="text" id="solicitante"></div> 
                    <div class="form-group"><label for="departamento">Departamento:</label><select id="departamento"><option value="" disabled selected>Seleccione</option><option>Oficina</option><option>Centro Distribución</option><option>Barrio México</option><option>San Francisco</option><option>Alto Valor</option><option>Directtools SF</option><option>Directtools BM</option></select></div>
                </div>
                <table id="pedido-table" class="responsive-table">
                    <thead><tr><th>Unidad</th><th>Artículo</th><th>Cantidad</th><th>Costo Total (₡)</th><th>Acción</th></tr></thead>
                    <tbody></tbody>
                </table>
                <h3 style="text-align:right; margin-top:20px;">Costo Total del Pedido: <span id="pedido-total-general">0.00</span> ₡</h3>
                <div class="controls">
                    <button onclick="agregarFila()" class="btn btn-add">➕ Agregar Artículo</button>
                    <button onclick="goBack()" class="btn btn-cancel">⬅️ Volver</button>
                    <button onclick="previsualizarPedido()" class="btn btn-send">📲 Previsualizar</button>
                </div>`;
            showView('formContainer');
            await cargarDatosEsenciales();
            agregarFila();
        }

        function agregarFila() {
            const tableBody = document.getElementById('pedido-table').querySelector('tbody');
            const newRow = tableBody.insertRow();
            const unidades = [...new Set(catalogoArticulos.map(item => item.unidad))];
            let opcionesUnidad = unidades.map(u => `<option value="${u}">${u}</option>`).join('');
            newRow.innerHTML = `
                <td data-label="Unidad"><select required onchange="actualizarArticulos(this)"><option value="" disabled selected>Seleccione</option>${opcionesUnidad}</select></td>
                <td data-label="Artículo"><select class="articulo-select" required disabled onchange="actualizarTotalesPedido()"><option value="" disabled selected>Seleccione unidad</option></select></td>
                <td data-label="Cantidad"><div style="display:flex;align-items:center;justify-content:flex-end;"><button class="btn" onclick="cambiarCantidad(this,-1)">-</button><span class="pedido-cantidad" style="padding:0 10px;font-weight:bold;">1</span><button class="btn" onclick="cambiarCantidad(this,1)">+</button></div></td>
                <td data-label="Costo Total" class="pedido-costo-total" style="font-weight:bold;">0.00</td>
                <td data-label="Acción"><button class="btn btn-danger" onclick="this.closest('tr').remove(); actualizarTotalesPedido();">Eliminar</button></td>`;
        }

        function actualizarArticulos(selectUnidad) {
            // ... (lógica existente para filtrar artículos) ...
            actualizarTotalesPedido();
        }
        
        function cambiarCantidad(btn,delta) {
            const display = btn.parentElement.querySelector('span');
            let val=parseInt(display.textContent)+delta;
            if(val<1)val=1;
            display.textContent=val;
            actualizarTotalesPedido();
        }

        function actualizarTotalesPedido() {
            let totalGeneral = 0;
            document.querySelectorAll('#pedido-table tbody tr').forEach(row => {
                const articulo = row.querySelector('.articulo-select').value;
                const cantidad = parseInt(row.querySelector('.pedido-cantidad').textContent) || 0;
                const costoProm = costosPromedio[articulo] || 0;
                const costoTotalItem = cantidad * costoProm;
                row.querySelector('.pedido-costo-total').textContent = costoTotalItem.toFixed(2);
                totalGeneral += costoTotalItem;
            });
            document.getElementById('pedido-total-general').textContent = totalGeneral.toFixed(2);
        }

        function previsualizarPedido() {
            // ... (lógica existente para recolectar datos) ...
            // Ahora, modifica el mensaje de WhatsApp para incluir los costos
            let whatsappMsg = `*Solicitud de Suministros* 📄\n------------------------------------\n`;
            whatsappMsg += `*Fecha:* ${new Date().toLocaleString("es-CR")}\n*Solicitante:* _${solicitante}_\n*Departamento:* _${departamento}_\n------------------------------------\n\n*Detalle:*\n`;
            let totalPedido = 0;
            pedidoItems.forEach(item => {
                const costoProm = costosPromedio[item.articulo] || 0;
                const costoTotalItem = item.cantidad * costoProm;
                whatsappMsg += `• ${item.articulo} (${item.cantidad} ${item.unidad}) - ₡${costoTotalItem.toFixed(2)}\n`;
                totalPedido += costoTotalItem;
            });
            whatsappMsg += `\n*Costo Total Estimado: ₡${totalPedido.toFixed(2)}*`;
            currentRequestData.whatsappBody = whatsappMsg;
            // ... (resto de la lógica para mostrar el modal) ...
        }

        // --- INVENTARIO (Ahora con valor de stock) ---
        async function showInventario() {
            views.inventarioContainer.innerHTML = `<h2>Resumen de Inventario</h2><table id="inventario-table" class="responsive-table"><thead><tr><th>Artículo</th><th>Unidad</th><th>Comprado</th><th>Solicitado</th><th>Stock Actual</th><th>Valor del Stock (₡)</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center">Calculando...</td></tr></tbody></table><div class="controls"><button class="btn btn-success" onclick="exportarInventarioExcel()">📊 Exportar a Excel</button><button class="btn btn-cancel" onclick="goBack()">⬅️ Volver</button></div>`;
            showView('inventarioContainer');
            try {
                await Promise.all([
                    cargarCatalogoArticulos(),
                    fetch(WEB_APP_URL).then(res => res.json()).then(data => historial = data),
                    fetch(`${WEB_APP_URL}?action=getCompras`).then(res => res.json()).then(data => historialCompras = data)
                ]);
                calcularCostosPromedio(); // Asegurarse de tener los costos más recientes

                const comprasAgrupadas = historialCompras.reduce((acc, compra) => {
                    acc[compra.articulo] = (acc[compra.articulo] || 0) + parseFloat(compra.cantidad);
                    return acc;
                }, {});
                const pedidosAgrupados = historial.flatMap(p => p.detalles).reduce((acc, item) => {
                    acc[item.articulo] = (acc[item.articulo] || 0) + parseFloat(item.cantidad);
                    return acc;
                }, {});

                inventario = catalogoArticulos.map(articulo => {
                    const totalComprado = comprasAgrupadas[articulo.nombre] || 0;
                    const totalPedido = pedidosAgrupados[articulo.nombre] || 0;
                    const stock = totalComprado - totalPedido;
                    const costoProm = costosPromedio[articulo.nombre] || 0;
                    return { 
                        nombre: articulo.nombre, 
                        unidad: articulo.unidad, 
                        comprado: totalComprado, 
                        solicitado: totalPedido, 
                        stock: stock,
                        valorStock: stock * costoProm
                    };
                });
                renderInventario();
            } catch (e) { console.error(e); }
        }
        function renderInventario() {
            const tableBody = views.inventarioContainer.querySelector("tbody");
            tableBody.innerHTML = inventario.map(item => `<tr><td data-label="Artículo">${item.nombre}</td><td data-label="Unidad">${item.unidad}</td><td data-label="Comprado">${item.comprado}</td><td data-label="Solicitado">${item.solicitado}</td><td data-label="Stock" style="font-weight:bold;">${item.stock}</td><td data-label="Valor Stock" style="font-weight:bold;">${item.valorStock.toFixed(2)} ₡</td></tr>`).join('');
        }
        function exportarInventarioExcel() {
            const data = inventario.map(i => ({ 
                Artículo: i.nombre, 
                Unidad: i.unidad, 
                Comprado: i.comprado, 
                Solicitado: i.solicitado, 
                "Stock Actual": i.stock,
                "Valor del Stock (₡)": i.valorStock.toFixed(2)
            }));
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
            XLSX.writeFile(workbook, `Resumen_Inventario_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // --- El resto de funciones (showHistory, showAdminArticulos, showCompras, etc.) permanecen aquí ---
        // Se omiten por brevedad, pero deben estar en tu archivo final.
        // Asegúrate de copiar este script completo para reemplazar el tuyo.
    </script>
</body>
</html>
