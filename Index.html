<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n - Tesoros Americanos Costa Rica</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #004d99; --secondary-color: #007bff; --text-color: #2c3e50; --light-text-color: #7f8c8d;
            --background-color: #ecf0f1; --card-background: #ffffff; --border-color: #dde1e5; --success-color: #27ae60;
            --danger-color: #e74c3c; --cancel-color: #95a5a6; --whatsapp-color: #25D366; --hover-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 2.5vw; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: auto; background: var(--card-background); padding: 3vw; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid var(--border-color); margin-bottom: 30px; }
        .header-logo { text-align: center; margin-bottom: 30px; }
        .header-logo img { max-width: 180px; }
        .header-logo h1 { margin: 0; padding-top: 15px; border-top: 2px solid var(--border-color); font-size: clamp(1.8em, 4vw, 2.5em); font-weight: 700; color: var(--primary-color); }
        .header-logo h2.subtitle { margin: 5px 0 0; font-size: clamp(1em, 2.5vw, 1.5em); font-weight: 500; color: var(--secondary-color); }
        h2 { text-align: center; color: var(--primary-color); margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); border-radius: 10px; overflow: hidden; }
        th, td { border: 1px solid var(--border-color); padding: 0.8em 1em; text-align: left; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 0.7em 0.8em; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        .btn { padding: 0.8em 1.5em; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s ease; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--hover-shadow); }
        .btn-add { background-color: var(--success-color); color: white; }
        .btn-send { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-whatsapp { background-color: var(--whatsapp-color); color: white; }
        .btn-cancel { background-color: var(--cancel-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .info-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5em; margin-bottom: 2em; }
        .form-group label { display: block; margin-bottom: 0.5em; font-weight: 500; color: var(--light-text-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; padding: 1em; }
        .modal-content { background-color: var(--card-background); padding: 2em; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 95%; max-width: 700px; position: relative; }
        .menu-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; margin-top: 2em; }
        .hidden { display: none; }
        .controls { margin-top: 40px; display: flex; justify-content: flex-end; gap: 1em; align-items: center; padding-top: 25px; border-top: 1px solid var(--border-color); flex-wrap: wrap; }
        @media screen and (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 20px; }
            .menu-options { grid-template-columns: 1fr; }
            .info-section { grid-template-columns: 1fr; }
            /* ... (los dem√°s estilos responsivos que ya ten√≠amos) ... */
        }
    </style>
</head>
<body>

    <div class="container" id="mainMenu">
        <div class="header-logo">
             <img src="data:image/svg+xml;base64," alt="Logo">
            <h1>Tesoros Americanos Costa Rica</h1>
            <h2 class="subtitle">Sistema de Gesti√≥n de Suministros</h2>
        </div>
        <div class="menu-options">
            <button class="btn" onclick="showForm()">üì¶ Nuevo Pedido</button>
            <button class="btn" onclick="showHistory()">üìú Ver Historial de Pedidos</button>
            <button class="btn" onclick="showAdminArticulos()">‚úèÔ∏è Administrar Art√≠culos</button>
            <button class="btn" onclick="showCompras()">üõí Registrar Compra</button>
        </div>
    </div>

    <div class="container hidden" id="formContainer"></div>

    <div class="container hidden" id="historyContainer"></div>
    
    <div class="container hidden" id="adminContainer">
        <h2>Administrar Lista de Art√≠culos</h2>
        <table id="admin-table">
            <thead><tr><th>Nombre del Art√≠culo</th><th>Unidad de Medida</th><th>Acci√≥n</th></tr></thead>
            <tbody></tbody>
        </table>
        <div class="controls">
            <button onclick="agregarFilaAdmin()" class="btn btn-add">‚ûï Agregar Art√≠culo</button>
            <button onclick="goBack()" class="btn btn-cancel">‚¨ÖÔ∏è Volver</button>
            <button onclick="guardarArticulos()" class="btn btn-send">üíæ Guardar Cambios</button>
        </div>
    </div>

    <div class="container hidden" id="comprasContainer">
        <h2>Registrar Compra a Proveedor</h2>
        <div class="info-section">
            <div class="form-group">
                <label for="compra-registradopor">Registrado por:</label>
                <input type="text" id="compra-registradopor" placeholder="Tu nombre completo">
            </div>
            <div class="form-group">
                <label for="compra-proveedor">Proveedor:</label>
                <input type="text" id="compra-proveedor" placeholder="Nombre del proveedor">
            </div>
            <div class="form-group">
                <label for="compra-fecha">Fecha de Compra:</label>
                <input type="date" id="compra-fecha">
            </div>
            <div class="form-group">
                <label for="compra-articulo">Art√≠culo Comprado:</label>
                <select id="compra-articulo"><option value="">Cargando art√≠culos...</option></select>
            </div>
            <div class="form-group">
                <label for="compra-cantidad">Cantidad:</label>
                <input type="number" id="compra-cantidad" placeholder="Ej: 10" min="1">
            </div>
            <div class="form-group">
                <label for="compra-costo">Costo Total (‚Ç°):</label>
                <input type="number" id="compra-costo" placeholder="Ej: 15000" min="0">
            </div>
        </div>
        <div class="controls">
            <button onclick="goBack()" class="btn btn-cancel">‚¨ÖÔ∏è Volver</button>
            <button onclick="registrarCompra()" class="btn btn-send">‚úÖ Registrar Compra</button>
        </div>
    </div>

    <div id="summaryModal" class="modal"></div>

    <script>
        // --- VARIABLES GLOBALES Y CONFIGURACI√ìN ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxZwboxYJuMqF6pwc8icP2F3j4Xywrjhyjgbor5fFrUmBXW3cTx18DlFm8CGfFyIOcRBQ/exec";
        let catalogoArticulos = [];
        let historial = [];
        let currentRequestData = {};

        // --- NAVEGACI√ìN ENTRE VISTAS ---
        const views = {
            mainMenu: document.getElementById('mainMenu'),
            formContainer: document.getElementById('formContainer'),
            historyContainer: document.getElementById('historyContainer'),
            adminContainer: document.getElementById('adminContainer'),
            comprasContainer: document.getElementById('comprasContainer'),
            summaryModal: document.getElementById('summaryModal')
        };
        function showView(viewId) {
            for (const key in views) {
                views[key].classList.add('hidden');
            }
            views[viewId].classList.remove('hidden');
        }
        function goBack() { showView('mainMenu'); }

        // --- L√ìGICA PRINCIPAL: CARGAR CAT√ÅLOGO ---
        async function cargarCatalogoArticulos() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getArticulos`);
                if (!response.ok) throw new Error('Error al cargar cat√°logo.');
                catalogoArticulos = await response.json();
            } catch (error) {
                console.error(error);
                alert("No se pudo cargar la lista de art√≠culos desde la base de datos.");
            }
        }
        
        // --- VISTA: NUEVO PEDIDO ---
        async function showForm() {
            views.formContainer.innerHTML = `<h2>Nuevo Pedido</h2>`; // Simplificado por brevedad
            views.formContainer.innerHTML = `<h2>Nuevo Pedido</h2> <div class="info-section"><div class="form-group"><label for="solicitante">Solicitado por:</label><input type="text" id="solicitante" placeholder="Nombre completo"></div> <div class="form-group"><label for="departamento">Departamento:</label><select id="departamento"><option value="" disabled selected>Seleccione</option><option>Oficina</option><option>Centro Distribuci√≥n</option><option>Barrio M√©xico</option><option>San Francisco</option><option>Alto Valor</option><option>Directtools SF</option><option>Directtools BM</option></select></div></div><table id="pedido-table"><thead><tr><th>Art√≠culo</th><th>Cantidad</th><th>Unidad</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table><div class="controls"><button onclick="agregarFila()" class="btn btn-add">‚ûï Agregar Art√≠culo</button><button onclick="goBack()" class="btn btn-cancel">‚¨ÖÔ∏è Volver</button><button onclick="previsualizarPedido()" class="btn btn-send">üì≤ Previsualizar</button></div>`;
            showView('formContainer');
            await cargarCatalogoArticulos();
            agregarFila();
        }
        function agregarFila() { /* ... (similar a la versi√≥n anterior) ... */ }
        function actualizarArticulos(selectUnidad) { /* ... (usa catalogoArticulos) ... */ }
        function previsualizarPedido() { /* ... (sin cambios) ... */ }
        async function guardarPedidoEnAPI(pedido) { /* ... (modificado para nuevo formato de API) ... */ }

        // --- VISTA: HISTORIAL DE PEDIDOS ---
        async function showHistory() {
             views.historyContainer.innerHTML = `<h2>Historial de Pedidos</h2><table id="historialTable"><thead>...</thead><tbody><tr><td colspan="5">Cargando...</td></tr></tbody></table><div class="controls">...</div>`; // Simplificado
             views.historyContainer.innerHTML = `<h2>Historial Central de Solicitudes</h2><table id="historialTable"><thead><tr><th style="width:5%"><input type="checkbox" onchange="toggleSeleccionarTodos(this)"></th><th>Fecha</th><th>Solicitante</th><th>Departamento</th><th>Detalles</th></tr></thead><tbody></tbody></table><div class="controls"><button class="btn btn-whatsapp" onclick="reenviarPedidosSeleccionados()">üì≤ Reenviar</button><button class="btn btn-cancel" onclick="goBack()">‚¨ÖÔ∏è Volver</button></div>`;
            showView('historyContainer');
             try {
                const response = await fetch(WEB_APP_URL); // La acci√≥n por defecto es getPedidos
                historial = await response.json();
                renderHistorial();
             } catch (e) { console.error(e); }
        }
        function renderHistorial() { /* ... (sin cambios) ... */ }

        // --- VISTA: ADMINISTRAR ART√çCULOS ---
        async function showAdminArticulos() {
            showView('adminContainer');
            const tableBody = views.adminContainer.querySelector('tbody');
            tableBody.innerHTML = '<tr><td colspan="3">Cargando art√≠culos...</td></tr>';
            await cargarCatalogoArticulos();
            tableBody.innerHTML = '';
            catalogoArticulos.forEach(item => {
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `<td><input type="text" value="${item.nombre}"></td><td><input type="text" value="${item.unidad}"></td><td><button class="btn btn-danger" onclick="this.closest('tr').remove()">Eliminar</button></td>`;
            });
        }
        function agregarFilaAdmin() {
            const tableBody = views.adminContainer.querySelector('tbody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `<td><input type="text" placeholder="Nuevo art√≠culo"></td><td><input type="text" placeholder="Unidad (Ej: Kilo)"></td><td><button class="btn btn-danger" onclick="this.closest('tr').remove()">Eliminar</button></td>`;
        }
        async function guardarArticulos() {
            const newArticulos = [];
            views.adminContainer.querySelectorAll('tbody tr').forEach(row => {
                const nombre = row.cells[0].querySelector('input').value.trim();
                const unidad = row.cells[1].querySelector('input').value.trim();
                if (nombre && unidad) {
                    newArticulos.push({ nombre, unidad });
                }
            });
            
            if (!confirm(`¬øEst√° seguro de que desea sobrescribir la lista de art√≠culos con ${newArticulos.length} registros? Esta acci√≥n no se puede deshacer.`)) return;

            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'updateArticulos', payload: newArticulos })
                });
                alert('¬°Lista de art√≠culos actualizada con √©xito!');
                catalogoArticulos = newArticulos; // Actualiza el cat√°logo local
                goBack();
            } catch (error) {
                alert('Error al guardar los art√≠culos.');
            }
        }

        // --- VISTA: REGISTRAR COMPRA ---
        async function showCompras() {
            showView('comprasContainer');
            await cargarCatalogoArticulos();
            const select = views.comprasContainer.querySelector('#compra-articulo');
            select.innerHTML = '<option value="" disabled selected>Seleccione un art√≠culo</option>';
            catalogoArticulos.forEach(item => {
                select.innerHTML += `<option value="${item.nombre}">${item.nombre}</option>`;
            });
            // Poner fecha actual por defecto
            document.getElementById('compra-fecha').valueAsDate = new Date();
        }
        async function registrarCompra() {
            const compra = {
                registradoPor: document.getElementById('compra-registradopor').value,
                proveedor: document.getElementById('compra-proveedor').value,
                fecha: document.getElementById('compra-fecha').value,
                articulo: document.getElementById('compra-articulo').value,
                cantidad: document.getElementById('compra-cantidad').value,
                costo: document.getElementById('compra-costo').value
            };
            if (!compra.registradoPor || !compra.proveedor || !compra.fecha || !compra.articulo || !compra.cantidad || !compra.costo) {
                return alert('Por favor, complete todos los campos.');
            }
            try {
                 await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'addCompra', payload: compra })
                });
                alert('¬°Compra registrada con √©xito!');
                // Limpiar formulario
                views.comprasContainer.querySelectorAll('input, select').forEach(el => el.value = '');
                document.getElementById('compra-fecha').valueAsDate = new Date();
                goBack();
            } catch (error) {
                alert('Error al registrar la compra.');
            }
        }
        
        // (Aqu√≠ ir√≠an las dem√°s funciones de apoyo como previsualizarPedido, cambiarCantidad, etc. que han sido omitidas por brevedad pero deben estar en tu c√≥digo final)
        // Nota: El c√≥digo completo es muy extenso, se han simplificado algunas funciones repetidas para claridad.
        // Aseg√∫rate de re-integrar las funciones completas de la versi√≥n anterior que no est√°n aqu√≠.

    </script>
</body>
</html>
