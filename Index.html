<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión Pedidos e Inventario</title>
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: #f7f9fc;
        margin: 0;
        padding: 0;
    }
    header {
        background: #1e3c72;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 1.4em;
        font-weight: bold;
    }
    nav {
        display: flex;
        background: #2a5298;
    }
    nav button {
        flex: 1;
        padding: 12px;
        background: #2a5298;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.3s;
    }
    nav button.active,
    nav button:hover {
        background: #1e3c72;
        font-weight: bold;
    }
    .tab-content {
        padding: 20px;
        display: none;
        animation: fadeIn 0.5s;
    }
    .tab-content.active {
        display: block;
    }
    @keyframes fadeIn {
        from {opacity: 0;}
        to {opacity: 1;}
    }
    .section {
        margin-top: 20px;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2, h3, h4 {
        color: #1e3c72;
    }
    select, input, button {
        padding: 8px;
        margin: 5px 5px 5px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 1em;
    }
    button {
        background: #1e3c72;
        color: white;
        cursor: pointer;
        transition: background 0.3s;
    }
    button:hover {
        background: #16345d;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: left;
        vertical-align: middle;
    }
    th {
        background: #2a5298;
        color: white;
    }
    tr:nth-child(even) {
        background: #f2f2f2;
    }
    .flex {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
</style>
</head>
<body>
<header>Gestión de Pedidos e Inventario</header>

<nav>
    <button class="tab-btn active" data-tab="pedidos">Pedidos</button>
    <button class="tab-btn" data-tab="inventario">Inventario</button>
</nav>

<!-- CONTENIDO PEDIDOS -->
<div id="pedidos" class="tab-content active">
    <div class="section">
        <h2>Pedidos</h2>
        <p><i>Funcionalidad original de pedidos aquí (puedes integrar tu código actual en este bloque)</i></p>
    </div>
</div>

<!-- CONTENIDO INVENTARIO -->
<div id="inventario" class="tab-content">
    <div class="section">
        <h2>Inventario</h2>
        <div class="flex">
            <button onclick="mostrarSubseccion('entrada')">Ajuste Entrada</button>
            <button onclick="mostrarSubseccion('salida')">Ajuste Salida</button>
        </div>
        
        <!-- FORMULARIO AJUSTE ENTRADA -->
        <div id="entrada" class="sub-section" style="display:none;">
            <h3>Ajuste de Entrada</h3>
            <label for="tipoEntrada">Tipo de Movimiento:</label>
            <select id="tipoEntrada">
                <option>Inventario Inicial</option>
                <option>Compra</option>
                <option>Corrección</option>
                <option>Donación</option>
            </select>
            <input type="text" id="detalleEntrada" placeholder="Detalle del movimiento" />
            
            <h4>Agregar Artículos</h4>
            <div class="flex">
                <select id="productoEntrada"></select>
                <input type="number" id="cantidadEntrada" placeholder="Cantidad" min="1" />
                <input type="number" id="costoEntrada" placeholder="Costo unitario" min="0" step="0.01" />
                <button onclick="agregarArticulo('entrada')">Agregar</button>
            </div>
            <table id="tablaEntrada">
                <thead>
                    <tr>
                        <th>Producto</th><th>Cantidad</th><th>Costo</th><th>Acción</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="confirmarAjuste('entrada')">Confirmar Ajuste</button>
        </div>
        
        <!-- FORMULARIO AJUSTE SALIDA -->
        <div id="salida" class="sub-section" style="display:none;">
            <h3>Ajuste de Salida</h3>
            <label for="tipoSalida">Tipo de Movimiento:</label>
            <select id="tipoSalida">
                <option>Corrección</option>
                <option>Daño</option>
                <option>Donación</option>
            </select>
            <input type="text" id="detalleSalida" placeholder="Detalle del movimiento" />
            
            <h4>Agregar Artículos</h4>
            <div class="flex">
                <select id="productoSalida"></select>
                <input type="number" id="cantidadSalida" placeholder="Cantidad" min="1" />
                <button onclick="agregarArticulo('salida')">Agregar</button>
            </div>
            <table id="tablaSalida">
                <thead>
                    <tr>
                        <th>Producto</th><th>Cantidad</th><th>Acción</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="confirmarAjuste('salida')">Confirmar Ajuste</button>
        </div>
    </div>
    
    <div class="section">
        <h3>Historial de Ajustes</h3>
        <table id="historial">
            <thead>
                <tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Movimiento</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="exportarExcel()">Exportar Excel</button>
        <button onclick="exportarPDF()">Exportar PDF</button>
    </div>
</div>

<!-- Librerías para exportar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
(() => {
    // Variables globales
    const productos = [
        {nombre: 'Producto A', stock: 10, costo: 100},
        {nombre: 'Producto B', stock: 20, costo: 50},
        {nombre: 'Producto C', stock: 15, costo: 80}
    ];
    const ajustes = [];

    // Inicializar selects productos
    const selects = [document.getElementById('productoEntrada'), document.getElementById('productoSalida')];
    selects.forEach(sel => {
        productos.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.nombre;
            opt.textContent = p.nombre;
            sel.appendChild(opt);
        });
    });

    // Control pestañas principales
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
        });
    });

    window.mostrarSubseccion = function(tipo) {
        document.querySelectorAll('.sub-section').forEach(s => s.style.display = 'none');
        document.getElementById(tipo).style.display = 'block';
    }

    window.agregarArticulo = function(tipo) {
        let producto = (tipo === 'entrada') ? document.getElementById('productoEntrada').value : document.getElementById('productoSalida').value;
        let cantidad = parseInt((tipo === 'entrada') ? document.getElementById('cantidadEntrada').value : document.getElementById('cantidadSalida').value);
        if (!producto) return alert('Seleccione un producto');
        if (!cantidad || cantidad <= 0) return alert('Cantidad debe ser mayor a cero');
        let costo = (tipo === 'entrada') ? parseFloat(document.getElementById('costoEntrada').value) : null;
        if (tipo === 'entrada' && (isNaN(costo) || costo < 0)) return alert('Ingrese un costo válido');

        const tabla = document.getElementById('tabla' + (tipo === 'entrada' ? 'Entrada' : 'Salida')).querySelector('tbody');
        // Validar si ya existe el producto agregado, sumar cantidades y promediar costo (entrada)
        let filaExistente = [...tabla.rows].find(row => row.cells[0].innerText === producto);
        if (filaExistente) {
            let cantActual = parseInt(filaExistente.cells[1].innerText);
            let nuevaCant = cantActual + cantidad;
            filaExistente.cells[1].innerText = nuevaCant;
            if (tipo === 'entrada') {
                let costoActual = parseFloat(filaExistente.cells[2].innerText);
                let nuevoCosto = ((costoActual * cantActual) + (costo * cantidad)) / nuevaCant;
                filaExistente.cells[2].innerText = nuevoCosto.toFixed(2);
            }
        } else {
            let fila = document.createElement('tr');
            fila.innerHTML = `<td>${producto}</td><td>${cantidad}</td>${tipo === 'entrada' ? `<td>${costo.toFixed(2)}</td>` : ''}<td><button onclick="this.parentNode.parentNode.remove()">Eliminar</button></td>`;
            tabla.appendChild(fila);
        }

        // Limpiar inputs
        if(tipo === 'entrada'){
            document.getElementById('cantidadEntrada').value = '';
            document.getElementById('costoEntrada').value = '';
        } else {
            document.getElementById('cantidadSalida').value = '';
        }
    }

    window.confirmarAjuste = function(tipo) {
        const tbody = document.querySelector(`#tabla${tipo === 'entrada' ? 'Entrada' : 'Salida'} tbody`);
        if (tbody.rows.length === 0) return alert('Agregue artículos antes de confirmar');

        const tipoMov = document.getElementById(`tipo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value;
        const detalle = document.getElementById(`detalle${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value;

        const movimiento = [];
        for(let fila of tbody.rows){
            const nombre = fila.cells[0].innerText;
            const cantidad = parseInt(fila.cells[1].innerText);
            const costo = (tipo === 'entrada') ? parseFloat(fila.cells[2].innerText) : null;
            const prod = productos.find(p => p.nombre === nombre);
            if(tipo === 'entrada'){
                // Calcular nuevo costo promedio
                const totalValor = (prod.stock * prod.costo) + (cantidad * costo);
                prod.stock += cantidad;
                prod.costo = totalValor / prod.stock;
            } else {
                prod.stock -= cantidad;
                if(prod.stock < 0) prod.stock = 0;
            }
            movimiento.push({nombre, cantidad, costo});
        }

        ajustes.push({fecha: new Date().toLocaleString(), tipo: tipoMov, detalle, movimiento});
        actualizarHistorial();

        alert('Ajuste registrado y stock actualizado');

        tbody.innerHTML = '';
        document.getElementById(`detalle${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value = '';
    }

    function actualizarHistorial() {
        const tbody = document.querySelector('#historial tbody');
        tbody.innerHTML = '';
        ajustes.forEach(a => {
            const mov = a.movimiento.map(m => `${m.nombre} (${m.cantidad})`).join(', ');
            const fila = document.createElement('tr');
            fila.innerHTML = `<td>${a.fecha}</td><td>${a.tipo}</td><td>${a.detalle}</td><td>${mov}</td>`;
            tbody.appendChild(fila);
        });
    }

    window.exportarExcel = function() {
        if(ajustes.length === 0) return alert('No hay datos para exportar');

        // Crear libro de Excel
        const wb = XLSX.utils.book_new();

        // Preparar datos
        const data = [['Fecha', 'Tipo', 'Detalle', 'Producto', 'Cantidad', 'Costo']];
        ajustes.forEach(a => {
            a.movimiento.forEach(m => {
                data.push([
                    a.fecha,
                    a.tipo,
                    a.detalle,
                    m.nombre,
                    m.cantidad,
                    m.costo !== null ? m.costo : ''
                ]);
            });
        });

        // Crear hoja y agregar datos
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Historial Ajustes');

        // Descargar archivo
        XLSX.writeFile(wb, 'Historial_Ajustes_Inventario.xlsx');
    }

    window.exportarPDF = function() {
        if(ajustes.length === 0) return alert('No hay datos para exportar');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.text("Historial de Ajustes de Inventario", 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);

        // Preparar columnas y filas para autoTable
        const columns = [
            { header: 'Fecha', dataKey: 'fecha' },
            { header: 'Tipo', dataKey: 'tipo' },
            { header: 'Detalle', dataKey: 'detalle' },
            { header: 'Producto', dataKey: 'producto' },
            { header: 'Cantidad', dataKey: 'cantidad' },
            { header: 'Costo', dataKey: 'costo' },
        ];

        const rows = [];
        ajustes.forEach(a => {
            a.movimiento.forEach(m => {
                rows.push({
                    fecha: a.fecha,
                    tipo: a.tipo,
                    detalle: a.detalle,
                    producto: m.nombre,
                    cantidad: m.cantidad,
                    costo: m.costo !== null ? m.costo.toFixed(2) : '',
                });
            });
        });

        doc.autoTable({
            startY: 30,
            columns: columns,
            body: rows,
            styles: { fontSize: 9 },
            headStyles: { fillColor: [42, 82, 152] },
            alternateRowStyles: { fillColor: [240, 240, 240] }
        });

        doc.save('Historial_Ajustes_Inventario.pdf');
    }
})();
</script>
</body>
</html>
